<!DOCTYPE html>
<html lang="en" layout:decorate="~{layout/layout_movie_get}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<body class="right-sidebar is-preload">
<th:block layout:fragment="content">
    <div id="page-wrapper">
        <div class="wrapper style1 movie_get">
            <div class="container" th:each="movie, iterStat : ${movieInfos}">
                <input type="hidden" id="movieId" th:value="${movie.id}">
                <div class="row">
                    <div class="col-12-mobile" id="content">
                        <article id="main">
                            <div class="movie_info_background">
                                <header id="get_info">
                                    <a href="#" class="image featured" onclick="toggleOverlay(this)">
                                        <img th:if="${#strings.length(movie.id) == 10}"
                                             th:src="@{|/${movie.posterPath}|}"
                                             class="featured-img"
                                             alt="ì˜í™”í¬ìŠ¤í„°"
                                        />
                                        <img th:if="${movie.posterPath != 'null' && movie.posterPath != '' && #strings.length(movie.id) != 10}"
                                             class="featured-img" id="resizedImageUrl"
                                             th:src="@{'https://image.tmdb.org/t/p/w500' + ${movie.posterPath}}"
                                             alt="ì˜í™”í¬ìŠ¤í„°"
                                        />
                                        <img th:if="${movie.posterPath == null || movie.posterPath == '' || movie.posterPath == 'null'}"
                                             class="featured-img"
                                             th:src="@{/images/img_not_ready2.png}"
                                             alt="ì¤€ë¹„ì¤‘ ì´ë¯¸ì§€"
                                        />
                                        <div class="movie-overlay">
                                            <img th:if="${#strings.length(movie.id) == 10}"
                                                 src="/images/magnifier2.png"
                                                 onclick="openModal(this.getAttribute('src'))"
                                                 alt="ë‹ë³´ê¸°"/>
                                            <img th:if="${movie.posterPath != 'null' && movie.posterPath != '' && #strings.length(movie.id) != 10}"
                                                 src="/images/magnifier2.png"
                                                 th:onclick="'openModal(\'' + @{'https://image.tmdb.org/t/p/original' + ${movie.posterPath}} + '\')'"
                                                 alt="ë‹ë³´ê¸°"/>
                                            <img src="/images/play.png" id="videoModalBtn"
                                                 th:data-video-id="${movie.video}" href="#"
                                                 class="video_btn" alt="íŠ¸ë ˆì¼ëŸ¬ ì¬ìƒ"/>
                                        </div>
                                    </a>

                                    <div class="movie_info">
                                        <span class="genres" th:text="${#strings.arrayJoin(movie.genres, ', ')}"></span>
                                        <header class="info_header">
                                            <div class="movie-title-box">
                                                <h3 th:text="${movie.title}" class="movie_title"></h3>
                                            </div>
                                            <div class="button_box">
                                                <div class="favorite-container">
                                                    <img id="favoriteButton" class="fav-icon"
                                                         src="/images/heart%20icon.png" alt="ì°œí•˜ê¸°(ì¢‹ì•„ìš”)">
                                                </div>
                                                <div class="btn_box">
                                                    <img onclick="shareMessage()" src="/images/share.png"
                                                         alt="ì¹´ì¹´ì˜¤í†¡ ê³µìœ " id="kakao_btn" class="kakao_btn"/>
                                                </div>
                                            </div>
                                        </header>

                                        <br>
                                        <div class="movie_detail">
                                            <span class="releaseDate"><b th:text="${movie.releaseDate}">releasedate</b></span>
                                            <span class="runtime"><b th:text="${movie.runtime} + 'ë¶„'">runtime</b></span>
                                            <img id="certification-image" src="" alt="ì˜í™”ì‹¬ì˜ë“±ê¸‰ ì´ë¯¸ì§€">
                                            <span id="certification">
                                                <b id="certificationB"
                                                   th:text="${movie.certifications}">certification</b>
                                            </span>
                                            <span>
                                                <b class="movie_data_averageRating"></b>
                                            </span>
                                        </div>
                                        <p th:text="${movie.overview}">
                                            ~ overview ~
                                        </p>
                                        <div class="button_box">
                                            <button class="reservation_btn"><a
                                                    th:href="@{'/reservation/screeningSchedule/' + ${movieId}}">ì˜ˆë§¤í•˜ê¸°</a>
                                            </button>
                                        </div>
                                    </div>
                                </header>
                            </div>
                            <div class="cast">
                                <h4>ì¶œì—°ì§„</h4>
                                <div id="cast-members">
                                </div>
                            </div>
                        </article>
                    </div>
                </div>

                <section class="movie_etc">
                    <div class="etc_btn">
                        <button type="button" class="button stillcut_btn clicked">ìŠ¤í‹¸ì»·</button>
                        <!-- ìˆ˜ì • ì»¨íŒ í•„ìš” -->
                        <button type="button" class="button reviews_btn"></button>
                    </div>
                </section>

                <!-- ë¹„ë””ì˜¤ íŠ¸ë ˆì¼ëŸ¬ ëª¨ë‹¬ -->
                <div id="videoModal" class="modal">
                    <div class="video-modal-content">
                        <span class="close">&times;</span>
                        <iframe id="videoFrame"
                                width="560"
                                height="315"
                                src="" frameborder="0"
                                allowfullscreen>
                        </iframe>
                    </div>
                </div>

                <!-- ìŠ¤í‹¸ì»· for each (ë°˜ë³µ) -->
                <!-- movieIdê°€ 10ìë¦¬ì¼ê²½ìš° == ê´€ë¦¬ìê°€ ì§ì ‘ ë“±ë¡í•œ ì˜í™” -->
                <!-- movieIdê°€ 10ìë¦¬ê°€ ì•„ë‹ê²½ìš° == APIì—ì„œ ë°›ì•„ì˜¨ ì˜í™” -->
                <div id="still-cut" th:each="movie, iterStat : ${movieInfos}">
                    <div class="row">
                        <div th:each="stillCutPath, iterStat : ${movie.stillCutPaths}"
                             th:classappend="${iterStat.count > 6} ? 'hide still-cut' : 'still-cut'"
                             class="col-4 col-12-mobile special">
                            <article class="still-cut-article">
                                <a href="#" class="image featured">
                                    <img th:if="${#strings.length(movie.id) == 10}"
                                         th:src="@{|/${stillCutPath}|}" alt="ìŠ¤í‹¸ì»·"
                                         onclick="openModal(this.getAttribute('src'))"
                                    />
                                    <img th:unless="${#strings.length(movie.id) == 10}"
                                         th:src="@{'https://image.tmdb.org/t/p/original/' + ${stillCutPath}}" alt="ìŠ¤í‹¸ì»·"
                                         onclick="openModal(this.getAttribute('src'))"
                                    />
                                </a>
                            </article>
                        </div>
                    </div>
                    <p id="showMore" class="cursor">
                        <a>
                            <img class="more_btn"
                                 src="/images/under-arrow.png"
                                 alt="ë”ë³´ê¸°"/>
                        </a>
                    </p>
                    <p id="showLess" class="cursor" style="display: none;">
                        <a>ì ‘ê¸°</a>
                    </p>
                </div>
                <!-- ë¦¬ì•¡ì…˜ ê´€ë ¨ div -->
                <div id="reviews" style="display: none">
                    <header>
                        <div class="reaction-container">
                            <div class="reaction-item">
                                <img id="likeButton" src="/images/like.png" alt="ì¬ë°Œì–´ìš”"
                                     onclick="react('LIKE')">
                                <span class="count like-count">0</span>
                            </div>
                            <div class="reaction-item">
                                <img id="dislikeButton" src="/images/dislike.png" alt="ì¬ë¯¸ì—†ì–´ìš”"
                                     onclick="react('DISLIKE')">
                                <span class="count dislike-count">0</span>
                            </div>
                            <div class="reaction-item">
                                <img id="sadButton" src="/images/sad.png" alt="ìŠ¬í¼ìš”"
                                     onclick="react('SAD')">
                                <span class="count sad-count">0</span>
                            </div>
                            <div class="reaction-item">
                                <img id="funnyButton" src="/images/funny.png" alt="ì›ƒê²¨ìš”"
                                     onclick="react('FUNNY')">
                                <span class="count funny-count">0</span>
                            </div>
                            <div class="reaction-item">
                                <img id="scaryButton" src="/images/scary.png" alt="ë¬´ì„œì›Œìš”"
                                     onclick="react('SCARY')">
                                <span class="count scary-count">0</span>
                            </div>
                        </div>
                        <button onclick="openReviewModal()" class="modal_open">ê´€ëŒí‰ ì‘ì„±í•˜ê¸°</button>
                    </header>
                    <div class="row">
                        <table class="default" id="reviews-table">
                            <!-- ëŒ“ê¸€ì´ ì—¬ê¸°ì— ì¶”ê°€ë  ê²ƒì…ë‹ˆë‹¤ -->
                        </table>
                    </div>
                    <p id="showMore_review" class="cursor">
                        <a>
                            <img class="more_btn"
                                 src="/images/under-arrow.png"
                                 alt="ë”ë³´ê¸°"/>
                        </a>
                    </p>
                    <p id="showLess_review" class="cursor" style="display: none;">
                        <a>ì ‘ê¸°</a>
                    </p>
                </div>
                <!-- ì´ë¯¸ì§€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
                <div id="myModal" class="modal">
                    <span class="close" onclick="closeModal()">&times;</span>
                    <img class="modal-content" id="modalImage">
                </div>
                <!-- ì•ˆì½ì€ ë©”ì„¸ì§€ í‘œì‹œ -->
                <div class="fixed-bottom-right" id="unreadMessages" onclick="redirectToChatRoom()">
                    <img src="/images/funny.png" alt="Unread Messages"> <!-- ì•ˆ ì½ì€ ë©”ì„¸ì§€ ì•„ì´ì½˜ ì´ë¯¸ì§€ ê²½ë¡œì— ë§ê²Œ ìˆ˜ì • -->
                    <!-- ì•ˆ ì½ì€ ë©”ì‹œì§€ ìˆ˜ë¥¼ í‘œì‹œí•  ìš”ì†Œ -->
                    <span id="unreadCount">0</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="/assets/js/jquery.min.js"></script>

    <!--              ëŒ“ê¸€         ------------------             -->
    <!--ìŠ¤ìœ—ì–¼ëŸ¿ ëª¨ë“ˆ-->
    <script type="module" src="/modules/alerts.js"></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var featuredImages = document.querySelectorAll('.image.featured');

            featuredImages.forEach(function (image) {
                image.addEventListener('mouseenter', function () {
                    toggleOverlay(this, true);
                });

                image.addEventListener('mouseleave', function () {
                    toggleOverlay(this, false);
                });
            });

            function toggleOverlay(element, show) {
                var overlay = element.querySelector('.movie-overlay');
                if (show) {
                    overlay.style.display = 'block';
                    overlay.style.display = 'flex';
                    overlay.style.flexDirection = 'row';
                    overlay.style.justifyContent = 'center';
                    overlay.style.alignItems = 'center';
                } else {
                    overlay.style.display = 'none';
                }
            }
        });

        const movieId = $('#movieId').val();

        // credits api ì œì‘ì§„ ì‚¬ì§„
        const options = {
            method: 'GET',
            headers: {
                accept: 'application/json',
                Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI3N2UzMWU5NWVjZmE3ZjBlODY5YTE3NmQwMjU0YWQwMiIsInN1YiI6IjY2NDJiMWM1ZTJlZjM4N2Y1MjM1OTNjZCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.hBVsW7eVrC2M3FdWc2OJEAWq0h4v-NiiM2YEDQoy7OU'
            }
        };

        // APIì—ì„œ ì˜í™” ì¶œì—°ì§„ë“¤ì„ ë°›ì•„ì™€ì„œ ë¿Œë ¤ì£¼ëŠ” í•¨ìˆ˜
        // movieIdê°€ 10ìë¦¬ì¼ê²½ìš° apiì—ì„œ ë°›ì•„ì˜¬ìˆ˜ì—†ê¸°ë•Œë¬¸ì— í•¨ìˆ˜ ìì²´ë¥¼ ì¢…ë£Œ
        async function fetchMovieCredits(movieId) {

            if (movieId.length === 10) {
                return;
            }

            try {
                const apiKey = '547e2cd4d0e26e68fb907dafef4f90ac';
                const url = `https://api.themoviedb.org/3/movie/${movieId}/credits?language=ko-KR&api_key=${apiKey}`;
                const response = await fetch(url);
                const data = await response.json();

                // ì˜í™” ì •ë³´ë¥¼ ë‹´ì„ ìš”ì†Œ ìƒì„±
                const castMembersDiv = document.getElementById('cast-members');
                castMembersDiv.style.display = 'flex'; // Flexbox ë ˆì´ì•„ì›ƒ ì ìš©
                castMembersDiv.style.flexWrap = 'wrap'; // ìš”ì†Œë“¤ì´ ë„˜ì¹˜ë©´ ë‹¤ìŒ ì¤„ë¡œ ë„˜ê¹€

                // ì˜í™” ê´€ëŒ ë“±ê¸‰
                const certificationElement = document.getElementById('certification');
                const certificationBElement = document.getElementById('certificationB');
                const certificationValue = certificationElement.textContent;
                const imgElement = document.getElementById('certification-image');

                switch (certificationValue) {
                    case '12ì„¸ ì´ìƒ ê´€ëŒê°€':
                        imgElement.src = '/images/ratings/12.png';
                        certificationBElement.style.color = '#EFC53C';
                        break;
                    case '15ì„¸ ì´ìƒ ê´€ëŒê°€':
                        imgElement.src = '/images/ratings/15.png';
                        certificationBElement.style.color = '#D98E04';
                        break;
                    case '18ì„¸ ì´ìƒ ê´€ëŒê°€':
                        imgElement.src = '/images/ratings/18.png';
                        certificationBElement.style.color = '#FF0000';
                        break;
                    case '19':
                        certificationElement.textContent = 'ì²­ì†Œë…„ ê´€ëŒë¶ˆê°€';
                        imgElement.src = '/images/ratings/18.png';
                        certificationBElement.style.color = '#FF0000';
                        break;
                    default:
                        imgElement.src = '/images/ratings/all.svg';
                        certificationBElement.style.color = '#237042';
                }

                // ê°ë… ì •ë³´ ì¶œë ¥ (ì´ë¯¸ì§€ í¬í•¨)
                const director = data.crew.find(person => person.job === 'Director');
                if (director) {
                    const directorDiv = createPersonDiv(director.name, director.profile_path, true);
                    castMembersDiv.appendChild(directorDiv); // directorDivë¥¼ movieInfoDivì— ì¶”ê°€
                }

                // ì¶œì—°ì§„ ì •ë³´ ì¶œë ¥ (ì´ë¯¸ì§€ í¬í•¨)
                data.cast.slice(0, 5).forEach(cast => {
                    const castDiv = createPersonDiv(cast.name, cast.profile_path);
                    castMembersDiv.appendChild(castDiv); // castDivë¥¼ movieInfoDivì— ì¶”ê°€
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        fetchMovieCredits(movieId);

        // ì¸ë¬¼ ì •ë³´ì™€ ì´ë¯¸ì§€ë¥¼ ë‹´ì€ div ìƒì„± í•¨ìˆ˜
        function createPersonDiv(name, profilePath, isDirector = false) {
            const personDiv = document.createElement('div'); // ìƒˆë¡œìš´ div ìƒì„±
            personDiv.style.marginRight = '13px'; // ê°„ê²© ì„¤ì •
            personDiv.style.width = '7em';
            personDiv.style.height = 'auto';

            const p = document.createElement('p');
            p.innerHTML = isDirector ? `<p>ê°ë… : ${name}</p>` : `<p>${name}</p>`;
            p.style.fontSize = '0.8em'; // ê¸€ì í¬ê¸° ì‘ê²Œ ì„¤ì •
            p.style.textAlign = 'center';

            const img = document.createElement('img');
            img.src = profilePath ? `https://image.tmdb.org/t/p/w200${profilePath}` : '/images/img_not_ready2.png';
            img.alt = `${name}'s profile image`;
            img.setAttribute('style', 'width: 100%; height: auto; border-radius: 10px;');

            personDiv.appendChild(img);
            personDiv.appendChild(p);

            return personDiv;
        }

        const api = {
            method: 'GET',
            headers: {
                accept: 'application/json',
                Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI3N2UzMWU5NWVjZmE3ZjBlODY5YTE3NmQwMjU0YWQwMiIsInN1YiI6IjY2NDJiMWM1ZTJlZjM4N2Y1MjM1OTNjZCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.hBVsW7eVrC2M3FdWc2OJEAWq0h4v-NiiM2YEDQoy7OU'
            }
        };

        // ìŠ¤í‹¸ì»· ë”ë³´ê¸°(more), ì ‘ê¸° í´ë¦­ í•¨ìˆ˜
        // í˜„ì¬ í‘œì‹œëœ í•­ëª©ì˜ ìˆ˜ë¥¼ ì¶”ì í•˜ëŠ” ë³€ìˆ˜
        let visibleCount = 6; // ì²˜ìŒì— ë³´ì´ëŠ” í•­ëª© ìˆ˜
        const increment = 8; // í•œ ë²ˆì— í‘œì‹œí•  ì¶”ê°€ í•­ëª© ìˆ˜

        // ìŠ¤í‹¸ì»·ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
        function hasStillCuts() {
            const stillCuts = document.querySelectorAll(".still-cut");
            return stillCuts.length > 0;
        }

        // ì´ˆê¸°ì— "ë”ë³´ê¸°" ë²„íŠ¼ì˜ í‘œì‹œ ì—¬ë¶€ë¥¼ ê²°ì •
        if (!hasStillCuts()) {
            document.getElementById("showMore").style.display = 'none';
        } else {
            document.getElementById("showMore").style.display = 'block';
        }

        // ë”ë³´ê¸° ë²„íŠ¼
        document.getElementById("showMore").addEventListener("click", function () {
            const stillCuts = document.querySelectorAll(".still-cut");
            const newVisibleCount = Math.min(visibleCount + increment, stillCuts.length);

            for (var i = visibleCount; i < newVisibleCount; i++) {
                stillCuts[i].classList.remove("hide");
            }
            visibleCount = newVisibleCount; // ì—…ë°ì´íŠ¸ëœ í‘œì‹œëœ í•­ëª©ì˜ ìˆ˜

            // "ì ‘ê¸°" ë²„íŠ¼ì„ í•­ìƒ ë³´ì—¬ì¤Œ
            document.getElementById("showLess").style.display = 'block';

            // ëª¨ë“  í•­ëª©ì´ í‘œì‹œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (visibleCount >= stillCuts.length) {
                // "ë”ë³´ê¸°"ë¥¼ ìˆ¨ê¹€
                this.style.display = 'none';
            } else {
                // ì•„ì§ í‘œì‹œë˜ì§€ ì•Šì€ í•­ëª©ì´ ìˆë‹¤ë©´ "ë”ë³´ê¸°"ë¥¼ ê³„ì† ë³´ì—¬ì¤Œ
                this.style.display = 'block';
            }
        });

        // ì ‘ê¸° ë²„íŠ¼
        document.getElementById("showLess").addEventListener("click", function () {
            var stillCuts = document.querySelectorAll(".still-cut");
            for (var i = 0; i < stillCuts.length; i++) {
                if (i > 5) { // ì²˜ìŒ 6ê°œë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                    stillCuts[i].classList.add("hide");
                }
            }
            visibleCount = 4; // "ì ‘ê¸°" í›„ ì²˜ìŒ í‘œì‹œëœ í•­ëª©ì˜ ìˆ˜ë¡œ ë¦¬ì…‹
            this.style.display = 'none'; // "ì ‘ê¸°"ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
            document.getElementById("showMore").style.display = 'block'; // "ë”ë³´ê¸°"ê°€ ë‹¤ì‹œ ë³´ì—¬ì§ˆ ìƒí™©ì„ ìœ„í•´
        });

        // ì´ë¯¸ì§€ í´ë¦­ì‹œ ì›ë³¸í¬ê¸°ë¡œ ë³¼ìˆ˜ìˆê²Œ ë„ìš°ëŠ” ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜ë“¤
        var currentScrollPosition = 0;

        function openModal(imageSrc) {
            var header = document.getElementById("header")
            header.style.display = "hide"
            currentScrollPosition = window.scrollY;
            document.body.style.overflow = 'hide';
            var modal = document.getElementById("myModal");
            var modalImg = document.getElementById("modalImage");
            modal.style.display = "block";
            modalImg.src = imageSrc;
        }

        function closeModal() {
            var header = document.getElementById("header");
            header.style.display = '';
            var modal = document.getElementById("myModal");
            modal.style.display = "none";
            document.body.style.overflow = '';
            // ìê¾¸ ëª¨ë‹¬ ë‹«ì„ë•Œ í¬ìŠ¤í„° ì´ë¯¸ì§€ í¬ê¸°ê°€ ë°”ë€Œì–´ì„œ
            // ê± ëª¨ë‹¬ í•¨ìˆ˜ì—ì„œ ë‹«ì„ë•Œ í¬ìŠ¤í„°ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ê°•ì œë¡œ ì„¤ì •í•´ì„œ í¬ê¸°ë³€ë™ì´ ì—†ëŠ”ê²ƒì²˜ëŸ¼ ë³´ì´ê²Œí•¨.
            document.querySelector('.image.featured img').style.width = '350px';
            document.querySelector('.image.featured img').style.height = '480px';
            window.scrollTo(0, currentScrollPosition);
        }


        /* ìœ íŠœë¸Œ íŠ¸ë ˆì¼ëŸ¬ ê´€ë ¨ ëª¨ë‹¬ ì‹œì‘ */
        document.addEventListener('DOMContentLoaded', function () {
            var openModalButton = document.getElementById('videoModalBtn');
            if (openModalButton) {
                openModalButton.addEventListener('click', function () {
                    var modal = document.getElementById('videoModal');
                    var videoId = openModalButton.getAttribute('data-video-id');
                    var videoFrame = document.getElementById('videoFrame');

                    var preparingImage = videoFrame.parentNode.querySelector('img');
                    if (preparingImage) {
                        preparingImage.remove();
                    }

                    if (videoId == null) {
                        // ë¹„ë””ì˜¤ IDê°€ ì—†ëŠ” ê²½ìš°, ì¤€ë¹„ì¤‘ ì´ë¯¸ì§€ í‘œì‹œ
                        videoFrame.style.display = 'none';
                        var preparingImage = document.createElement('img');
                        preparingImage.src = '/images/video_not_ready.jpg'; // ì¤€ë¹„ì¤‘ ì´ë¯¸ì§€ URL
                        preparingImage.style.width = '100%';
                        preparingImage.style.height = '100%';
                        videoFrame.parentNode.appendChild(preparingImage);
                    } else {
                        // ë¹„ë””ì˜¤ IDê°€ ìˆëŠ” ê²½ìš°, ë¹„ë””ì˜¤ í‘œì‹œ
                        var videoUrl = 'https://www.youtube.com/embed/' + videoId;
                        videoFrame.src = videoUrl;
                        videoFrame.style.display = 'block';
                    }

                    modal.style.display = "flex"; // flexë¡œ ë³€ê²½
                    document.body.style.overflow = 'hide'; // ìŠ¤í¬ë¡¤ ë§‰ê¸°
                });

                document.getElementsByClassName('close')[0].addEventListener('click', function () {
                    var modal = document.getElementById('videoModal');
                    modal.style.display = "none";
                    document.getElementById('videoFrame').src = ""; // ë¹„ë””ì˜¤ ì¤‘ì§€
                    document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µì›
                });
            }
        });

        /* ìœ íŠœë¸Œ íŠ¸ë ˆì¼ëŸ¬ ê´€ë ¨ ëª¨ë‹¬ ë */

        // ë²„íŠ¼ í´ë¦­ ì‹œ ìŠ¤í‹¸ì»· ë˜ëŠ” ë¦¬ë·° í…Œì´ë¸”
        document.addEventListener('DOMContentLoaded', function () {

            var stillCutBtn = document.querySelector(".stillcut_btn");
            var reviewsBtn = document.querySelector(".reviews_btn");
            var stillCutDiv = document.getElementById("still-cut");
            var reviewsDiv = document.getElementById("reviews");

            stillCutBtn.addEventListener("click", function () {
                stillCutDiv.style.display = "block";
                reviewsDiv.style.display = "none";
                stillCutBtn.classList.add("clicked");
                reviewsBtn.classList.remove("clicked");
            });

            reviewsBtn.addEventListener("click", function () {
                stillCutDiv.style.display = "none";
                reviewsDiv.style.display = "block";
                reviewsBtn.classList.add("clicked");
                stillCutBtn.classList.remove("clicked");
            });
        });

        // ë¦¬ë·° ì‘ì„± ëª¨ë‹¬ì„ íŒì—… ì°½ìœ¼ë¡œ ì—´ê¸°
        function openReviewModal() {
            // ëŒ“ê¸€ ì‘ì„± ì—¬ë¶€ í™•ì¸
            $.ajax({
                url: `/movies/hasCommented/${movieId}`,
                method: 'GET',
                dataType: 'json',
                success: function (hasCommented, textStatus, xhr) {

                    if (hasCommented) {
                        Swal.fire({
                            position: "center",
                            icon: "info",
                            title: "ì´ë¯¸ ëŒ“ê¸€ì„ ì‘ì„±í•˜ì…¨ìŠµë‹ˆë‹¤.",
                            showConfirmButton: false,
                            timer: 1500
                        });
                    } else {
                        var reviewWindow = window.open('/review/' + movieId, 'ReviewModal', 'width=600,height=400');
                        var checkWindowClosed = setInterval(function () {
                            if (reviewWindow.closed) {
                                clearInterval(checkWindowClosed);
                                loadComments();
                            }
                        }, 500); // 0.5ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
                    }
                },
                error: function (xhr, status, error) {
                    if (xhr.status === 401) {
                        Swal.fire({
                            position: "center",
                            icon: "warning",
                            title: "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.",
                            showConfirmButton: false,
                            timer: 1500
                        });
                    } else {
                        console.error("ëŒ“ê¸€ ì‘ì„± ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:", error);
                    }
                }
            });
        }

        // ë¶€ëª¨ ì°½ì—ì„œ ëŒ“ê¸€ ë“±ë¡ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
        window.addEventListener('commentRegistered', function (event) {
            if (event.detail.success) {
                // ëŒ“ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŒì„ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
                    showConfirmButton: false,
                    timer: 1500
                });
                // í•„ìš”í•œ í›„ì²˜ë¦¬ ì‘ì—… ìˆ˜í–‰ (ì˜ˆ: ëŒ“ê¸€ ëª©ë¡ ì—…ë°ì´íŠ¸)
                loadComments();
            } else {
                // ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨ ì²˜ë¦¬
                console.error("ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë“± ì¶”ê°€ì ì¸ ì˜¤ë¥˜ ì²˜ë¦¬ ê°€ëŠ¥
            }
        });

        //            ëŒ“ê¸€ë¦¬ìŠ¤íŠ¸    --------------------------------------------------
        const loadComments = () => {

            const emojiMap = {
                1: 'ğŸ˜¡',
                2: 'ğŸ˜ ',
                3: 'ğŸ˜',
                4: 'ğŸ˜Š',
                5: 'ğŸ˜'
            };

            $.ajax({
                url: `/movies/` + movieId,
                method: 'GET',
                dataType: 'json',
                success: (data) => {

                    let currentCommentIndex = 0;
                    const maxCommentDisplay = 3;
                    const remainingCommentCount = data.comments.length - currentCommentIndex;

                    //í‰ì 
                    const movieDataSection = $('.movie_data_averageRating');
                    movieDataSection.text(`${data.averageRating !== null ? data.averageRating : 0}`);

                    const reviewsBtn = $('.reviews_btn');
                    reviewsBtn.text('ê´€ëŒí‰ (' + data.comments.length + ')');

                    //ëŒ“ê¸€ì •ë³´
                    const reviewsSection = $('#reviews-table');
                    reviewsSection.empty();
                    data.comments.forEach((comment, index) => {
                        if (index < maxCommentDisplay) {
                            appendReviewRow(reviewsSection, comment, emojiMap);
                        }
                    });

                    if (remainingCommentCount > 0) {
                        $('#showMore_review').show(); // "more" ë²„íŠ¼ í‘œì‹œ
                    } else {
                        $('#showMore_review').hide(); // "more" ë²„íŠ¼ ìˆ¨ê¹€
                    }

                    if (currentCommentIndex > 0) {
                        $('#showLess_review').show(); // "ì ‘ê¸°" ë²„íŠ¼ í‘œì‹œ
                    } else {
                        $('#showLess_review').hide(); // "ì ‘ê¸°" ë²„íŠ¼ ìˆ¨ê¹€
                    }

                    // "ë”ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                    $('#showMore_review').click(() => {
                        currentCommentIndex += maxCommentDisplay;
                        reviewsSection.empty();
                        data.comments.forEach((comment, index) => {
                            if (index < currentCommentIndex + maxCommentDisplay) {
                                appendReviewRow(reviewsSection, comment, emojiMap);
                            }
                        });

                        $('#showMore_review').toggle(currentCommentIndex + maxCommentDisplay < data.comments.length);
                        $('#showLess_review').show();
                    });

                    // "ì ‘ê¸°" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                    $('#showLess_review').click(() => {
                        currentCommentIndex = 0;
                        reviewsSection.empty();
                        data.comments.forEach((comment, index) => {
                            if (index < maxCommentDisplay) {
                                appendReviewRow(reviewsSection, comment, emojiMap);
                            }
                        });
                        $('#showMore_review').show();
                        $('#showLess_review').hide();
                    });
                },
                error: (xhr, status, error) => {
                    console.error("ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:", error);
                    $('#comments').append(`<div class="error"><p>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p></div>`);
                }
            });
        };

        loadComments();

        //ì´ë©”ì¼ ì²˜ë¦¬
        function maskEmail(email) {
            const atIndex = email.indexOf('@');
            let emailName = email.slice(0, atIndex);
            const emailDomain = email.slice(atIndex + 1);

            if (emailName.length > 3) {
                emailName = `${emailName.slice(0, -3)}***`;
            } else {
                emailName = '***';
            }
            return `${emailName}@${emailDomain}`;
        }

        function generateStars(grade) {
            return 'â˜…'.repeat(grade);
        }

        //ëŒ“ê¸€ ìˆ˜ë§Œí¼ ë°˜ë³µìƒì„±
        function appendReviewRow(reviewsSection, comment, emojiMap) {
            const maskedEmail = maskEmail(comment.memberEmail);
            const stars = generateStars(comment.grade);
            const emoji = emojiMap[comment.grade] || '';
            const isOwner = userEmail === comment.memberEmail;
            // const adming =
            const reviewRow = `

        <tr>
            <td>
                <div class="review">
                    <h4 class="review-user-email">${maskedEmail}</h4>
                    <span class="review-emoji">${emoji}</span>
                    <input class="review-stars" type="radio" id="${comment.grade}-stars" value="${comment.grade}" checked="checked" />
                    <span class="review-comment" style="margin-left: 40px">${comment.comment}</span>
                    <div class="review-right">
                        <span class="review-date">${new Date().toISOString().slice(0, 10)}</span>
                          ${isOwner ? `<button class="delete-btn" data-comment-id="${comment.cno}" style="margin-left: 20px;">ì‚­ì œ</button>` : ''}
                    </div>
                </div>
            </td>
        </tr>
    `;
            reviewsSection.append(reviewRow);
        }

        // ì°œí•˜ê¸° ê´€ë ¨ í•¨ìˆ˜ ì‹œì‘ //
        $(document).ready(function () {

            let isFavorited = false; // í˜„ì¬ ì‚¬ìš©ìì˜ ì°œí•˜ê¸°(ì¢‹ì•„ìš”) ìƒíƒœë¥¼ ì €ì¥í•  ë³€ìˆ˜ì„

            // í˜„ì¬ ì°œí•˜ê¸° ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ì„œë²„ì—ì„œ ìƒíƒœ í˜¸ì¶œ
            $.ajax({
                url: '/favorites/check/' + userEmail + '/' + movieId,
                type: 'GET',
                data: {
                    userEmail: userEmail,
                    movieId: movieId
                },
                success: function (response) {
                    // ì‘ë‹µì—ì„œ í˜„ì¬ ë¦¬ì•¡ì…˜ ìƒíƒœë¥¼ ë°›ì•„ì™€ ë²„íŠ¼ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
                    isFavorited = response.isFavorited;
                    updateFavoriteButton(isFavorited)
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching current reaction:', status, error);
                }
            });

            // ì°œí•˜ê¸° ë²„íŠ¼ì„ í´ë¦­í–ˆì„ë•Œ ì°œí•˜ê¸° ë²„íŠ¼ì˜ ìƒíƒœì—ë”°ë¼ ì„œë²„ì— ìš”ì²­ì„ë³´ëƒ„
            // ì°œí•˜ê¸° ë²„íŠ¼ì´ ì´ë¯¸ í´ë¦­í•œ ìƒíƒœì¼ë•Œ -> ì°œí•˜ê¸° ì·¨ì†Œ
            // ì°œí•˜ê¸° ë²„íŠ¼ì´ í´ë¦­í•˜ì§€ ì•Šì€ ìƒíƒœì¼ë•Œ -> ì°œëª©ë¡ ì¶”ê°€
            $("#favoriteButton").click(function () {

                checkAnonymousUser();

                if (isFavorited === false) {
                    // ì°œí•˜ê¸° ìš”ì²­ (POST ìš”ì²­)
                    $.ajax({
                        url: '/favorites/' + userEmail + '/' + movieId,
                        type: 'POST',
                        success: function (response) {
                            isFavorited = true;
                            updateFavoriteButton(isFavorited)
                        },
                        error: function (xhr, status, error) {
                            console.error("ì¢‹ì•„ìš” ë“±ë¡ ì‹¤íŒ¨", error)
                        }
                    });
                } else {
                    // ì°œí•˜ê¸° ì‚­ì œìš”ì²­ (DELETE ìš”ì²­)
                    $.ajax({
                        url: '/favorites/' + userEmail + '/' + movieId,
                        type: 'DELETE',
                        success: function (response) {
                            isFavorited = false;
                            updateFavoriteButton(isFavorited)
                        },
                        error: function (xhr, status, error) {
                            console.error("ì¢‹ì•„ìš” ë“±ë¡ ì‹¤íŒ¨", error)
                        }
                    });
                }
            });

            // ë²„íŠ¼ìƒíƒœ í‘œì‹œí•˜ëŠ” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            // í´ë˜ìŠ¤ì— ë”°ë¼ cssê°€ ë°”ë€Œì–´ì„œ í´ë¦­í•œê²ƒê³¼ ì•ˆí•œê²ƒ í‘œì‹œ ë‹¤ë¥´ê²Œ í•¨
            function updateFavoriteButton(isFavorited) {
                var favoriteButton = $('#favoriteButton');
                if (isFavorited) {
                    favoriteButton.addClass('favorited'); // ì°œí•œ ìƒíƒœ í´ë˜ìŠ¤ ì¶”ê°€
                } else {
                    favoriteButton.removeClass('favorited'); // ì°œí•œ ìƒíƒœ í´ë˜ìŠ¤ ì œê±°
                }
            }
        });


        /* ì¢‹ì•„ìš” ì‹«ì–´ìš” ìŠ¬í¼ìš” ë“±ë“± ë¦¬ì•¡ì…˜ ê´€ë ¨ í•¨ìˆ˜ ì‹œì‘ */

        var currentReactions = {}; // ì‚¬ìš©ìì˜ í˜„ì¬ ë¦¬ì•¡ì…˜ ì„ íƒì„ ì¶”ì í•˜ëŠ” ê°ì²´

        var userEmail = [[${userEmail}]];

        var isRequestPending = false; // ë¹„ë™ê¸° ìš”ì²­ ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸

        var userCurrentReaction = null; // í˜„ì¬ ì‚¬ìš©ìì˜ ë¦¬ì•¡ì…˜ ìƒíƒœë¥¼ ì €ì¥í•  ë³€ìˆ˜

        // ë¹„íšŒì› ì²´í¬
        function checkAnonymousUser() {
            if (!userEmail || userEmail === 'anonymousUser') {
                window.warningAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return true;
            }
            return false;
        }

        // ë¦¬ì•¡ì…˜ ì¶”ê°€ í•¨ìˆ˜
        async function addReaction(userEmail, movieId, reactionType) {

            if (isRequestPending) {
                return; // ë¹„ë™ê¸° ìš”ì²­ ì¤‘ì´ë©´ í´ë¦­ì„ ë¬´ì‹œ
            }
            isRequestPending = true; // ë¹„ë™ê¸° ìš”ì²­ ì‹œì‘

            try {
                if (!currentReactions) {
                    currentReactions = {};
                }

                if (!(movieId in currentReactions)) {
                    currentReactions[movieId] = {};
                }

                var currentMemberReaction = currentReactions[movieId][userEmail];

                if (currentMemberReaction === reactionType) {
                    await removeReaction(userEmail, movieId, reactionType);
                    delete currentReactions[movieId][userEmail];
                } else {
                    if (currentMemberReaction) {
                        await removeReaction(userEmail, movieId, currentMemberReaction);
                    }
                    await sendReaction(userEmail, movieId, reactionType);
                    currentReactions[movieId][userEmail] = reactionType;
                }
            } catch (error) {
                console.error('Error processing reaction:', error);
            } finally {
                isRequestPending = false;
            }
        }

        // ë¦¬ì•¡ì…˜ ì„œë²„ë¡œ ë³´ë‚´ëŠ” í•¨ìˆ˜
        function sendReaction(userEmail, movieId, reactionType, retryCount = 0) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: '/add',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        userEmail: userEmail,
                        movieId: movieId,
                        reactionType: reactionType
                    }),
                    success: function (response) {
                        console.log('Response:', response);
                        updateReactionCount(movieId);
                        resolve(response);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error removing reaction:', status, error);
                        if (retryCount < 3) {
                            console.log(`Retrying... (${retryCount + 1}/3)`);
                            resolve(removeReaction(userEmail, movieId, reactionType, retryCount + 1));
                        } else {
                            console.log('XHR Object:', xhr);
                            console.log('Response Text:', xhr.responseText);
                            reject(error);
                        }
                    }
                });
            });
        }

        // ì„œë²„ì—ì„œ ë¦¬ì•¡ì…˜ ìˆ«ìë°›ì•„ì™€ì„œ ì¹´ìš´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateReactionCount(movieId) {
            $.ajax({
                url: '/movie/' + movieId,
                type: 'GET',
                success: function (response) {
                    $('#likeCount_' + movieId).text(response.likeCount);
                    $('#dislikeCount_' + movieId).text(response.dislikeCount);
                    $('#sadCount_' + movieId).text(response.sadCount);
                    $('#funnyCount_' + movieId).text(response.funnyCount);
                    $('#scaryCount_' + movieId).text(response.scaryCount);
                },
                error: function (xhr, status, error) {
                    console.error("Error updating reaction count", error);
                }
            });
        }

        // ë¦¬ì•¡ì…˜ ì‚­ì œ
        function removeReaction(userEmail, movieId, reactionType, retryCount = 0) {
            var data = {
                userEmail: userEmail,
                movieId: movieId,
                reactionType: reactionType
            };
            // movieId(ì˜í™”ì‹ë³„ì •ë³´)ê°€ ì—†ê±°ë‚˜ userEmail(íšŒì›ì •ë³´,ë¡œê·¸ì¸ì •ë³´)ê°€ ì—†ìœ¼ë©´ return
            // ë²„íŠ¼ì—°íƒ€ì‹œ ajax ìš”ì²­ ê¼¬ì´ëŠ”ê±° ë°©ì§€í• ë ¤ê³  ì¶”ê°€í•¨
            if (!userEmail || !movieId) {
                console.error('Error removing reaction: userEmail or movieId is missing');
                return;
            }

            return new Promise((resolve, reject) => {
                $.ajax({
                    url: '/remove',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        console.log('Response:', response);
                        updateReactionCount(movieId);
                        if (currentReactions[movieId]) {
                            delete currentReactions[movieId][userEmail];
                            if (Object.keys(currentReactions[movieId]).length === 0) {
                                delete currentReactions[movieId];
                            }
                        }
                        resolve(response);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error removing reaction:', status, error);
                        if (retryCount < 3) {
                            console.log(`Retrying... (${retryCount + 1}/3)`);
                            resolve(removeReaction(userEmail, movieId, reactionType, retryCount + 1));
                        } else {
                            console.log('XHR Object:', xhr);
                            console.log('Response Text:', xhr.responseText);
                            reject(error);
                        }
                    }
                });
            });
        }

        // ì‚¬ìš©ìì˜ í˜„ì¬ ë¦¬ì•¡ì…˜ ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        // í˜ì´ì§€ ë¡œë“œì‹œ ë°”ë¡œ ë°œë™ë˜ê²Œ í•´ë†“ìŒ
        // í˜„ì¬ ë¦¬ì•¡ì…˜ìƒíƒœë¥¼ ê°€ì ¸ì™€ì„œ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì¤‘ë³µìœ¼ë¡œ ëˆ„ë¥¼ìˆ˜ìˆë˜ë¶€ë¶„ í•´ê²°
        function initializeReactions() {
            // í˜„ì¬ ë¦¬ì•¡ì…˜ ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ API í˜¸ì¶œ
            $.ajax({
                url: '/getCurrentReaction',
                type: 'GET',
                data: {
                    userEmail: userEmail,
                    movieId: movieId
                },
                success: function (response) {
                    // ì‘ë‹µì—ì„œ í˜„ì¬ ë¦¬ì•¡ì…˜ ìƒíƒœë¥¼ ë°›ì•„ì™€ ë²„íŠ¼ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
                    userCurrentReaction = response.reactionType;
                    updateButtonState()
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching current reaction:', status, error);
                }
            });
        }

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì¶”ê°€
        function updateButtonState() {
            // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ë¥¼ ì œê±°
            $('#likeButton, #dislikeButton, #sadButton, #funnyButton, #scaryButton').removeClass('active');

            // í˜„ì¬ ë¦¬ì•¡ì…˜ì— í•´ë‹¹í•˜ëŠ” ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
            // active í´ë˜ìŠ¤ í™œìš©í•´ì„œ ì„ íƒí•œë²„íŠ¼ì—ë§Œ cssë¥¼ ì¶”ê°€í•´ ê¾¸ë°€ìˆ˜ìˆìŒ
            if (userCurrentReaction === 'LIKE') {
                $('#likeButton').addClass('reaction, active');
            } else if (userCurrentReaction === 'DISLIKE') {
                $('#dislikeButton').addClass('reaction, active');
            } else if (userCurrentReaction === 'SAD') {
                $('#sadButton').addClass('reaction, active');
            } else if (userCurrentReaction === 'reaction, active') {
                $('#funnyButton').addClass('reaction, active');
            } else if (userCurrentReaction === 'SCARY') {
                $('#scaryButton').addClass('reaction, active');
            }
        }

        // ë¦¬ì•¡ì…˜ì´ ì„ íƒë˜ìˆëŠ” ìƒíƒœì—ì„œ ë‹¤ë¥¸ ë¦¬ì•¡ì…˜ ì„ íƒ ( ê¸°ì¡´ ë¦¬ì•¡ì…˜ì´ ì‚­ì œë˜ê³  ìƒˆ ë¦¬ì•¡ì…˜ì´ ì¶”ê°€ë¨)
        function react(reactionType) {

            // ë¹„íšŒì› ì²´í¬
            if (checkAnonymousUser()) {
                return;
            }
            // ì´ì „ì— ì„ íƒí•œ ë¦¬ì•¡ì…˜ì„ ì„œë²„ì—ì„œ ì‚­ì œ
            if (userCurrentReaction === reactionType) {
                removeReaction(userEmail, movieId, reactionType)
                userCurrentReaction = null;// ì´ì „ ë¦¬ì•¡ì…˜ ìƒíƒœë¥¼ ì´ˆê¸°í™”
                updateButtonState()
                return;
            } else if (userCurrentReaction) {
                removeReaction(userEmail, movieId, reactionType);
                updateButtonState()
            }
            // ìƒˆë¡œìš´ ë¦¬ì•¡ì…˜ì„ ì¶”ê°€í•˜ê³  í´ë¼ì´ì–¸íŠ¸ ì¸¡ì˜ ë¦¬ì•¡ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            addReaction(userEmail, movieId, reactionType)
            userCurrentReaction = reactionType; // ìƒˆë¡œìš´ ë¦¬ì•¡ì…˜ ìƒíƒœ ì„¤ì •
            updateButtonState()
        }

        function updateMetaDescription() {
            var detailElement = document.querySelector('.movie_detail');
            if (detailElement) {
                var detailText = detailElement.innerText;
                var metaDescription = document.getElementById('og-description');
                if (metaDescription) {
                    metaDescription.setAttribute('content', detailText);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {

            updateMetaDescription();
            // Kakao SDK ì´ˆê¸°í™”
            Kakao.init('3d074cbbda365535b831c90baead22c2'); // ì—¬ê¸°ì— ì‹¤ì œ Kakao ì•± í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.

            var likeCountSpans = document.querySelectorAll('.like-count');
            var dislikeCountSpans = document.querySelectorAll('.dislike-count');
            var sadCountSpans = document.querySelectorAll('.sad-count');
            var funnyCountSpans = document.querySelectorAll('.funny-count');
            var scaryCountSpans = document.querySelectorAll('.scary-count');

            // ë¦¬ì•¡ì…˜ divì— id ì„¤ì •í•˜ëŠ” ë¶€ë¶„
            likeCountSpans.forEach(span => {
                span.id = 'likeCount_' + movieId;
            });
            dislikeCountSpans.forEach(span => {
                span.id = 'dislikeCount_' + movieId;
            });
            sadCountSpans.forEach(span => {
                span.id = 'sadCount_' + movieId;
            });
            funnyCountSpans.forEach(span => {
                span.id = 'funnyCount_' + movieId;
            });
            scaryCountSpans.forEach(span => {
                span.id = 'scaryCount_' + movieId;
            });
            updateReactionCount(movieId);
            initializeReactions();
        });

        $(document).on('click', '.delete-btn', function () {
            const cno = $(this).data('comment-id');
            deleteComment(cno);
        });

        function deleteComment(cno) {
            // ë¨¼ì € SweetAlertë¡œ ì‚­ì œë¥¼ ì§„í–‰í•  ê²ƒì¸ì§€ ì‚¬ìš©ìì—ê²Œ í™•ì¸í•©ë‹ˆë‹¤.
            Swal.fire({
                title: "ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                text: "ì‚­ì œ í•˜ë©´ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "ì‚­ì œ",
                cancelButtonText: "ì·¨ì†Œ"
            }).then((result) => {
                if (result.isConfirmed) {
                    // ì‚¬ìš©ìê°€ ì‚­ì œë¥¼ í™•ì¸í•œ ê²½ìš°ì—ë§Œ ì‚­ì œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
                    $.ajax({
                        url: `/movies/delete/${cno}`,
                        method: 'DELETE',
                        success: function (response) {
                            // ì‚­ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì´ë£¨ì–´ì¡ŒìŒì„ ì‚¬ìš©ìì—ê²Œ ì•Œë¦½ë‹ˆë‹¤.
                            Swal.fire({
                                title: "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤",
                                text: "ì •ìƒì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!",
                                icon: "success"
                            }).then(() => {
                                // ì‚¬ìš©ìê°€ í™•ì¸ì„ í´ë¦­í•œ ê²½ìš°ì—ë§Œ ëŒ“ê¸€ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.
                                loadComments(); // ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
                            });
                        },
                        error: function (xhr, status, error) {
                            window.errorAlert("ëŒ“ê¸€ì„ ì‚­ì œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        }
                    });
                }
            });
        }

        // Kakao ê³µìœ  í•¨ìˆ˜
        function shareMessage() {
            const currentUrl = window.location.href;
            const urlSegments = currentUrl.split('/');
            const movieId = urlSegments[urlSegments.length - 1];

            const titleElement = document.querySelector('.movie_title');
            const releaseDateElement = document.querySelector('.releaseDate');
            const runtimeElement = document.querySelector('.runtime');
            const imageElement = document.getElementById('resizedImageUrl');
            const genresElement = document.querySelector('.genres');
            const certificationElement = document.getElementById('certification'); // ì‹¬ì˜ ë“±ê¸‰ ìš”ì†Œ

            if (titleElement && releaseDateElement && runtimeElement && imageElement && genresElement) {
                const title = titleElement.innerText.trim(); // trim()ì„ ì‚¬ìš©í•˜ì—¬ ì¢Œìš° ê³µë°± ì œê±°
                const releaseDate = releaseDateElement.innerText.trim(); // ê°œë´‰ ë‚ ì§œ
                const runtime = runtimeElement.innerText.trim(); // ìƒì˜ ì‹œê°„
                const imageUrl = imageElement.src

                const genres = genresElement.innerText.trim(); // ì¥ë¥´ ê°€ì ¸ì˜¤ê¸°
                const certificationValue = certificationElement.textContent;

                Kakao.Link.sendDefault({
                    objectType: 'feed',
                    content: {
                        title: title, // ì œëª©
                        description: `ê°œë´‰ : ${releaseDate}  ìƒì˜ ì‹œê°„: ${runtime} \nì¥ë¥´: ${genres} ë“±ê¸‰: ${certificationValue}`, // ìƒì„¸ ë‚´ìš©ì— ì •ë³´ ì¶”ê°€
                        imageUrl: imageUrl, // ì´ë¯¸ì§€ URL
                        link: {
                            mobileWebUrl: `http://localhost:8080/movies/${movieId}`, // ë™ì  ì´ë²¤íŠ¸ IDë¥¼ í¬í•¨í•œ URL
                            webUrl: `http://localhost:8080/movies/${movieId}`
                        }
                    }
                });
            } else {
                console.error('í•„ìš”í•œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì§ì ‘ ë“±ë¡í•œ ì˜í™” ë°°ìš°ëª©ë¡ í™”ë©´ì— ë„ìš°ê¸°
        document.addEventListener("DOMContentLoaded", function () {

            // movieIdê°€ 10ìë¦¬ì¸ ê²½ìš°ì—ë§Œ ì‹¤í–‰ë˜ëŠ” ì½”ë“œ
            if (movieId.length === 10) {
                // ë¬´ë¹„ IDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„œë²„ì— ìš”ì²­í•˜ì—¬ í•´ë‹¹ ë¬´ë¹„ì— ì¶œì—°í•œ ë°°ìš°ë“¤ì˜ ID ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´
                fetch(`/actors/${movieId}`)
                    .then(response => response.json())
                    .then(actorIds => {
                        // ê° ë°°ìš°ì˜ IDë¥¼ ì‚¬ìš©í•˜ì—¬ ì¶”ê°€ì ì¸ ë°ì´í„°ë¥¼ ìš”ì²­í•˜ê³  ì²˜ë¦¬
                        actorIds.forEach(actorId => {
                            fetch(`/actor/${actorId}`)
                                .then(response => response.json())
                                .then(actorData => {
                                    // actorDataë¥¼ ì‚¬ìš©í•˜ì—¬ í•„ìš”í•œ ì‘ì—… ìˆ˜í–‰
                                    // ê° ë°°ìš° ì •ë³´ë¥¼ í™”ë©´ì— ì¶”ê°€ (ê°€ë¡œë¡œ ë‚˜ì—´)
                                    const castMembersDiv = document.getElementById('cast-members');
                                    castMembersDiv.style.display = 'flex'; // Flexbox ë ˆì´ì•„ì›ƒ ì ìš©
                                    castMembersDiv.style.flexWrap = 'wrap'; // ìš”ì†Œë“¤ì´ ë„˜ì¹˜ë©´ ë‹¤ìŒ ì¤„ë¡œ ë„˜ê¹€
                                    const actorDiv = createPersonDiv(actorData.actorName, actorData.actorProfilePic);
                                    castMembersDiv.appendChild(actorDiv);
                                })
                                .catch(error => {
                                    console.error('Error fetching actor data:', error);
                                });
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching actor IDs:', error);
                    });
            }

            // ì¸ë¬¼ ì •ë³´ì™€ ì´ë¯¸ì§€ë¥¼ ë‹´ì€ div ìƒì„± í•¨ìˆ˜
            function createPersonDiv(name, profilePath) {
                const personDiv = document.createElement('div'); // ìƒˆë¡œìš´ div ìƒì„±
                personDiv.style.margin = '13px'; // ê°„ê²© ì„¤ì •
                personDiv.style.width = '7em';
                personDiv.style.height = 'auto';
                personDiv.style.borderRadius = '10px';

                const p = document.createElement('p');
                p.innerHTML = `<p>${name}</p>`;
                p.style.fontSize = '0.8em'; // ê¸€ì í¬ê¸° ì‘ê²Œ ì„¤ì •
                p.style.textAlign = 'center';

                const img = document.createElement('img');
                img.src = profilePath ? `https://image.tmdb.org/t/p/w200${profilePath}` : '/images/img_not_ready2.png';
                img.alt = `${name}'s profile image`;
                img.setAttribute('style', 'width: 100%; height: auto; border-radius: 10px;');

                personDiv.appendChild(img);
                personDiv.appendChild(p);

                return personDiv;
            }
        });

        //ë©”ì„¸ì§€ì•ŒëŒ ëˆ„ë¥´ë©´ ì±„íŒ…ë°©ì´ë™
        function redirectToChatRoom() {
            window.location.href = '/chatUser';
        }

    </script>
</th:block>
</body>
</html>